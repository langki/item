window.onload = function () {
    
    var pageindex =1;
    var pagesize = 10;

    var currbdlnt;
    var currbdlat;
    
    function GetCurrbdgps() {
        // debugger;
        console.log(3);
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);
        } else {
            x.innerHTML = "Geolocation is not supported by this browser.";
        }
        
    }
    function showPosition(position) {
        // debugger;
        console.log(1);
        currbdlat = position.coords.latitude;
        currbdlnt = position.coords.longitude;
    
        GetAreaCode();
    }
    
    var createMap = function (data) {
        // 百度地图API功能
        var map = new BMap.Map("allmap");    // 创建Map实例
        map.centerAndZoom(new BMap.Point(currbdlnt, currbdlat), 12);  // 初始化地图,设置中心点坐标和地图级别
        map.addControl(new BMap.MapTypeControl());   //添加地图类型控件
        map.setCurrentCity("杭州");          // 设置地图显示的城市 此项是必须设置的
        map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
        // //向地图中添加缩放控件
        var ctrlNav = new window.BMap.NavigationControl({
            anchor: BMAP_ANCHOR_TOP_LEFT,
            type: BMAP_NAVIGATION_CONTROL_LARGE
        });
        map.addControl(ctrlNav);
        
        var markerArr = [];
        
        data.forEach(function (key, index) {
            markerArr.push({
                title: key.unitname,
                point: key.gpsbd.split(",")[1] + "," + key.gpsbd.split(",")[0],
                address: key.address
            })
        });
        
        console.log(markerArr);
        
        var point = new Array(); //存放标注点经纬信息的数组
        var marker = new Array(); //存放标注点对象的数组
        var info = new Array(); //存放提示信息窗口对象的数组
        for (var i = 0; i < markerArr.length; i++) {
            var p0 = markerArr[i].point.split(",")[0]; //
            var p1 = markerArr[i].point.split(",")[1]; //按照原数组的point格式将地图点坐标的经纬度分别提出来
            point[i] = new window.BMap.Point(p0, p1); //循环生成新的地图点
            marker[i] = new window.BMap.Marker(point[i]); //按照地图点坐标生成标记
            map.addOverlay(marker[i]);
            marker[i].setAnimation(BMAP_ANIMATION_BOUNCE); //跳动的动画
            var label = new window.BMap.Label(markerArr[i].title, {offset: new window.BMap.Size(20, -10)});
            marker[i].setLabel(label);
            info[i] = new window.BMap.InfoWindow("<p style=’font-size:12px;lineheight:1.8em;’>" + markerArr[i].title + "</br>地址：" + markerArr[i].address + "</br> 电话：" + markerArr[i].tel + "</br></p>"); // 创建信息窗口对象
        }
    }
    
    var pid = GetQueryString("pid");
    
    function GetAreaCode() {
        
        $.getJSON("https://rapi.zjwist.com/WapDisplay/areacodelist", {pid: pid}, function (data) {
            if (data.code == 0) {
                
                var typeinfostr = "";
                
                $.each(data.data, function (index, typeinfo) {
                    typeinfostr += "<option value='" + typeinfo.areacode + "'>" + typeinfo.areaname + "</option>";
                    
                    
                });
                
                $(".area").html(typeinfostr);
                
                getList();
                
            }
        });
    }
    
    
    // 为jquery扩展了一个getUrlParam()方法  来获取url参数
    (function ($) {
        $.getUrlParam = function (name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) {
                return unescape(r[2]);
            }
            return null;
        }
    })(jQuery);
    // 首次渲染页面
    
    // 渲染函数
    function getList() {
        var key = $(".search").val();
        var areacode = $("#selectareacode").val();
        var sort = $("#sort").val();
        var typeid = $.getUrlParam('typeid');
        var pid = $.getUrlParam('pid');
        // var currgpsbd = $.getUrlParam('currgpsbd');
        console.log(2);
        $.getJSON("https://rapi.zjwist.com/wapdisplay/GetUnitList", {
            areacode: areacode, // 这个参数应该是从上一个页面来的
            pid: pid, // 这个参数应该是从上一个页面来的
            typeid: typeid, // 这个参数应该是从上一个页面来的
            currbdlnt: currbdlnt,//经度,
            currbdlat: currbdlat,//纬度
            pageindex: pageindex, // 这个参数是无限加载的, 加载一次就+1
            pagesize: pagesize,
            key: key,
            sort: sort
        }, function (data) {
            if (data.code == 0) {
                // 在这里面, 去渲染数据, 把数据组装起来
                var unitinfostr = "";
                var star = "AAAAA";
                
                $.each(data.data, function (index, unitinfo) {
                    unitinfostr += "<a href='details.html?unitid=" + unitinfo.unitid + "'><div class='details_one'>";
                    unitinfostr += "<img src='" + unitinfo.flagpic + "?width=130'>";
                    unitinfostr += "<h1>" + unitinfo.unitname + "</h1>";
                    if (unitinfo.address) {
                        unitinfostr += "<p>" + unitinfo.address + "</p>";
                    } else {
                        unitinfostr += "<p> </p>";
                    }
                    unitinfostr += "<div class='details_four_two'>";
                    if (unitinfo.level > 0 && unitinfo.level < 6) {
                        
                        unitinfostr += "<div class='details_four'>";
                        unitinfostr += "<p>" + star.substr(0, unitinfo.level) + "</p>";
                        unitinfostr += "</div>";
                    }
                    
                    
                    unitinfostr += "<div class='details_four_one'>";
                    unitinfostr += "<p>距离" + parseInt(unitinfo.distance * 100, 10) / 100 + "km</p>";
                    unitinfostr += "</div>";
                    unitinfostr += "</div>";
                    unitinfostr += "</div>";
                });
                
                $("#view").append(unitinfostr);
                
                if ((pageindex*pagesize)>data.totalcount) {
                    $(".bttom").html("没有更多数据哦！");
                }

                createMap(data.data);
            }
        });
    }

    $(".J-load-more").on("click", function (ev) {
        ev.stopPropagation();
        pageindex++;
        getList();
    });
    // 搜索事件
    $("#search").on("keyup", function () {
        getList()
    })
    // 切换地区事件
    $("#selectareacode").change(function () {
        getList();
    })
    // 切换排序方式事件
    $("#sort").change(function () {
        getList();
    })
    //获取当前百度经纬度
    GetCurrbdgps();
    
    // GetAreaCode();
}


